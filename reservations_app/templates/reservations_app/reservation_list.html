{% extends "reservations_app/base.html" %}
{% load static %}

{% block content %}
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 0.8rem 1rem;
        text-align: left;
        /* tous les titres + colonnes bien align√©s */
    }

    th {
        font-weight: bold;
        font-size: 1.1rem;
    }
</style>

<style>
    .btn-action {
        padding: .3rem .6rem;
        background: #4c6fff;
        color: white;
        border-radius: 4px;
        text-decoration: none;
        margin-right: .4rem;
        font-size: .9rem;
    }

    .btn-action:hover {
        background: #3a56d4;
    }

    .btn-danger {
        background: #e04545;
    }

    .btn-danger:hover {
        background: #c73030;
    }
</style>

<h1>R√©servations</h1>

<p><a href="{% url 'reservation_create' %}?next={{ request.get_full_path|urlencode }}">
        + Nouvelle r√©servation
    </a>
</p>

<form method="get" action="">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: nowrap;">

        <!-- Barre de recherche large -->
        <input type="text" name="q" value="{{ q|default:'' }}"
            placeholder="Rechercher (nom, t√©l√©phone, email, commentaire, date, heure)"
            style="flex: 1 1 auto; min-width: 400px;">

        <!-- Filtres dates -->
        <input type="date" name="date_start" value="{{ date_start|default:'' }}">
        <input type="date" name="date_end" value="{{ date_end|default:'' }}">

        <!-- Filtres min / max personnes -->
        <input type="number" name="min_p" min="1" value="{{ min_p|default:'' }}" placeholder="Min pers.">
        <input type="number" name="max_p" min="1" value="{{ max_p|default:'' }}" placeholder="Max pers.">

        <!-- Bouton rechercher -->
        <button type="submit">
            Rechercher
        </button>

        <!-- Lien r√©initialiser -->
        <a href="{% url 'reservation_list' %}" style="margin-left: 4px;">
            R√©initialiser
        </a>

    </div>
</form>
</form>

<p style="font-size: 0.9rem; color: #666; margin-top: 8px;">
    üí° Astuce : vous pouvez filtrer par nom, email, t√©l√©phone, dates et nombre de personnes.
</p>
{% if messages %}
<ul style="padding:0;">
    {% for message in messages %}
    <li style="
        list-style:none;
        margin:.5rem 0;
        padding:.75rem;
        border-radius:8px;
        background-color:{% if message.tags == 'success' %}#eafbea{% elif message.tags == 'error' %}#fdecea{% else %}#f0f0f0{% endif %};
        border:1px solid {% if message.tags == 'success' %}#b7e4c7{% elif message.tags == 'error' %}#f5b5b5{% else %}#ddd{% endif %};
      ">
        {{ message }}
    </li>
    {% endfor %}
</ul>
{% endif %}

<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: .6rem .5rem;
        border-bottom: 1px solid #ddd;
    }

    th a {
        text-decoration: none;
        color: inherit;
    }

    tr:hover {
        background-color: #fafafa;
    }
</style>

<table>
    <thead>
        <tr>
            <th>
                <a
                    href="?q={{ q }}&date_start={{ date_start }}&date_end={{ date_end }}&min_p={{ min_p }}&max_p={{ max_p }}&sort=date&dir={% if sort == 'date' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Date
                    {% if sort == 'date' %}
                    {% if dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                    {% else %}
                    ‚ñµ
                    {% endif %}

                </a>
            </th>

            <th>
                <a
                    href="?q={{ q }}&date_start={{ date_start }}&date_end={{ date_end }}&min_p={{ min_p }}&max_p={{ max_p }}&sort=heure&dir={% if sort == 'heure' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Heure {% if sort == 'heure' %}{% if dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}{% endif %}
                </a>
            </th>

            <th>
                <a
                    href="?q={{ q }}&date_start={{ date_start }}&date_end={{ date_end }}&min_p={{ min_p }}&max_p={{ max_p }}&sort=nom&dir={% if sort == 'nom' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Client {% if sort == 'nom' %}{% if dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}{% endif %}
                </a>
            </th>

            <th>
                <a
                    href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort=personnes&dir={% if sort == 'personnes' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Personnes {% if sort == 'personnes' %}{% if dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}{% endif %}
                </a>
            </th>
            <th>
                <a
                    href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort=tel&dir={% if sort == 'tel' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    T√©l√©phone {% if sort == 'tel' %}{% if dir == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}{% endif %}
                </a>
            </th>
            <th style="text-align:center;">Actions</th>

        </tr>
    </thead>
    <tbody>
        {% for r in page_obj %}
        <tr>
            <!-- Date : format Nov. 3, 2025 -->
            <td>{{ r.date_reservation|date:"M. j, Y" }}</td>

            <!-- Heure : format 24h 19:00, 14:20, etc. -->
            <td>{{ r.heure_reservation|time:"H:i" }}</td>

            <!-- Client -->
            <td>{{ r.nom_client }}</td>

            <!-- Personnes -->
            <td>{{ r.nombre_personnes }}</td>

            <!-- T√©l√©phone -->
            <td>{{ r.telephone }}</td>

            <!-- Actions (avec conservation des filtres) -->
            <td style="text-align:center;">
                <a href="{% url 'reservation_detail' r.pk %}{% if query_string %}?{{ query_string }}{% endif %}"
                    class="btn-action">
                    Voir
                </a>

                <a href="{% url 'reservation_update' r.pk %}{% if query_string %}?{{ query_string }}{% endif %}"
                    class="btn-action">
                    Modifier
                </a>

                <a href="{% url 'reservation_delete' r.pk %}{% if query_string %}?{{ query_string }}{% endif %}"
                    class="btn-action">
                    Supprimer
                </a>




            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="text-align:center;">
                Aucune r√©servation trouv√©e pour ces crit√®res.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<nav style="margin-top:1rem; display:flex; gap:.5rem; align-items:center;">
    {% if page_obj.has_previous %}
    <a href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort={{ sort }}&dir={{ dir }}&page=1">¬´ Premi√®re</a>
    <a
        href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort={{ sort }}&dir={{ dir }}&page={{ page_obj.previous_page_number }}">‚Äπ
        Pr√©c√©dente</a>
    {% endif %}

    <span>Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a
        href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort={{ sort }}&dir={{ dir }}&page={{ page_obj.next_page_number }}">Suivante
        ‚Ä∫</a>
    <a
        href="?{% if q %}q={{ q|urlencode }}&{% endif %}sort={{ sort }}&dir={{ dir }}&page={{ page_obj.paginator.num_pages }}">Derni√®re
        ¬ª</a>
    {% endif %}
</nav>

<p><a href="{% url 'reservation_list' %}">Retour √† l‚Äôaccueil</a></p>
{% endblock %}